<h1>This is the show page</h1>

<h2><%= @address.name %></h2>
<p><%= @address.address %></p>
<p><%= @address.kind_of_place %></p>
<p><%= @address.place_in_building %></p>
<p><%= @address.floor %></p>
<p><%= @address.elevator %></p>
<p><%= @address.description %></p>
<%= cl_image_tag @address.photo.key, height: 300, width: 400, crop: :fill %>
<%= link_to "My addresses", addresses_path %>


<%= link_to "Edit my address", edit_address_path %>
  <div class = "delete-button1">
      <%= link_to "Delete address", address_path(@address),
    data: {turbo_method: :delete, turbo_confirm: "Are you sure?"}%>
    </div>

<div id="capture" style="padding-top: 30px; background: #f5da55">
    <h2 style="color: #000; ">Hello world!- this is a test for screenshot</h2>
</div>

<div>
<button onclick="takeScreenshot()" style="float: right:">take screenshot</button>

</div>

<br>
<br>
<div data-controller="map"
  id="map"
  data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"
  data-map-markers-value="<%= @markers.to_json %>"
  preserveDrawingBuffer="true"
  style="width: 100%; height: 300px;">
</div>
<br>
<br>



<div>
      <canvas
        id="canvas"
        width="500"
        height="200"
        style="border: 1px solid black;"
      ></canvas>
    </div>
    <div style="margin-top: 5px;">
      <span>Size: </span>
      <input
        type="range"
        min="1"
        max="50"
        value="25"
        class="size"
        id="sizeRange"
      />
    </div>
    <div style="margin-top: 5px;">
      <span>Color: </span>
      <input type="radio" name="colorRadio" value="black" checked />
      <label for="black">Black</label>
      <input type="radio" name="colorRadio" value="white" />
      <label for="black">White</label>
      <input type="radio" name="colorRadio" value="red" />
      <label for="black">Red</label>
      <input type="radio" name="colorRadio" value="green" />
      <label for="black">Green</label>
      <input type="radio" name="colorRadio" value="blue" />
      <label for="black">Blue</label>
    </div>
    <div style="margin-top: 5px;">
      <button id="clear">Clear</button>
    </div>
    <br />
    <input id="upload" type="file" accept="image/*" />
    <p>
      Start drawing on the blank canvas, or upload an image and use the brush to
      draw on it
    </p>



<script>
  const takeScreenshot = (event) => {
    html2canvas(document.querySelector("#map")).then(canvas => {
      canvas.id = "canvas"
      const canvasNode = document.getElementById("canvas")
      canvasNode.parentNode.replaceChild(canvas, canvasNode)
    });
  }

  const fileInput = document.querySelector("#upload");

// enabling drawing on the blank canvas
drawOnImage();

fileInput.addEventListener("change", async (e) => {
  const [file] = fileInput.files;

  // displaying the uploaded image
  const image = document.createElement("img");
  image.src = await fileToDataUri(file);

  // enbaling the brush after after the image
  // has been uploaded
  image.addEventListener("load", () => {
    drawOnImage(image);
  });

  return false;
});

function fileToDataUri(field) {
  return new Promise((resolve) => {
    const reader = new FileReader();

    reader.addEventListener("load", () => {
      resolve(reader.result);
    });

    reader.readAsDataURL(field);
  });
}

const sizeElement = document.querySelector("#sizeRange");
let size = sizeElement.value;
sizeElement.oninput = (e) => {
  size = e.target.value;
};

const colorElement = document.getElementsByName("colorRadio");
let color;
colorElement.forEach((c) => {
  if (c.checked) color = c.value;
});

colorElement.forEach((c) => {
  c.onclick = () => {
    color = c.value;
  };
});

function drawOnImage(image = null) {
  const canvasElement = document.getElementById("canvas");
  const context = canvasElement.getContext("2d");

  // if an image is present,
  // the image passed as a parameter is drawn in the canvas
  if (image) {
    const imageWidth = image.width;
    const imageHeight = image.height;

    // rescaling the canvas element
    canvasElement.width = imageWidth;
    canvasElement.height = imageHeight;

    context.drawImage(image, 0, 0, imageWidth, imageHeight);
  }

  const clearElement = document.getElementById("clear");
  clearElement.onclick = () => {
    context.clearRect(0, 0, canvasElement.width, canvasElement.height);
  };

  let isDrawing;

  canvasElement.onmousedown = (e) => {
    isDrawing = true;
    context.beginPath();
    context.lineWidth = size;
    context.strokeStyle = color;
    context.lineJoin = "round";
    context.lineCap = "round";
    context.moveTo(e.clientX, e.clientY);
  };

  canvasElement.onmousemove = (e) => {
    if (isDrawing) {
      context.lineTo(e.clientX, e.clientY);
      context.stroke();
    }
  };

  canvasElement.onmouseup = function () {
    isDrawing = false;
    context.closePath();
  };
}
</script>
